<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/google-apis/google-apis.html">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">


<dom-module id="map-search">

	<template>
		<style>
		
			#map_canvas{
				height: 450px;
				width: 100%;
				transition: height 200ms;
			}
			
			paper-icon-button {
				color: white;
			}
		
		</style>

		<div id="wrap">
			<paper-toolbar id="map_functions">
				<span class="title">Classifieds</span>
				<div id="draw">
					<a href="#" on-click="draw" target="_self" tabindex="-1">
						<paper-icon-button id="draw_icon" icon="create"></paper-icon-button>
					</a>
				</div>
				<div id="clear">
					<a href="#" on-click="clear" target="_self" tabindex="-1">
						<paper-icon-button icon="clear"></paper-icon-button>
					</a>
				</div>
				<div id="filter">
					<a href="#" on-click="filter" target="_self" tabindex="-1">
						<paper-icon-button icon="filter-list"></paper-icon-button>
					</a>
				</div>
				<div id="reload"> 
					<a href="#" on-click="reload" target="_self" tabindex="-1">
						<paper-icon-button icon="refresh"></paper-icon-button>
					</a>
				</div>
				<div id="minimize">
					<a href="#"  on-click="minimize" target="_self" tabindex="-1">
						<paper-icon-button icon="expand-less" id="min_button"></paper-icon-button>
					</a>
				</div>
				<div id="collapse">
					<a href="#" on-click="collapse" target="_self" tabindex="-1">
						<paper-icon-button icon="fullscreen-exit" id="collapse_button"></paper-icon-button>
					</a>
				</div>
				
			</paper-toolbar>
		</div>	
		<div id="map_canvas"></div>
		
		<google-maps-api api-key="AIzaSyBbbTEqaAjcWVDdrIpwlS-0Tl4CTheJThE" version="3.exp"></google-maps-api>
		
		<iron-ajax
			id="marker_loader"
			handle-as="json"
			debounce-duration="300"
			on-response="itemsLoaded"
			last-response="{{ items }}"
			last-error="{{ lastError }}"
			verbose=true
		></iron-ajax>
		
	</template>
	
  <script>
	
	var mapsInitialized, listeners = [];
	
	Polymer({
	is: 'map-search',

	properties : {
		map : { type: Object },
		
		/*default center of the map*/
		defaultCenter : {
			type : Object,
			value : {
				lat:50.0755,
				lng:14.4378
			},
			readOnly: true
		},
		
		/*point at which to center map at*/
		displayCenter : {
			type : Object,
			observer : '_centerChanged'
		},
		
		/*default map load*/
		defaultMapOptions : {
			type : Object,
			value : {
				zoom: 17,
			}
		},
		
		/*Will be given by user, sets map zoom to fit bounds of circle of radius in km*/
		displayRadius : {
			type : Number,
			observer : '_radiusChanged'
		},
		
		originalMapHeight : { type : Number },
		
		/*All markers that have been loaded onto the map*/
		allMarkers : { type : Array, value : [] },
		
		/*All polys that have been loaded onto the map*/
		allPolys : { type : Array, value : [] },
		
		/*if true, beginning to draw a new poly will erase previous polys*/
		onePolyActive : { type : Boolean, value : true, readOnly : true },
		
		defaultIcon : {
			type : String,
			value : 'http://46.101.211.226:5000/media/assets/theme-vinegret/logo-vinegret-mobile.png'
		},
		
		/*as var name says, percent of height to minimize to when asked to minimize*/
		percentMinimize : { type : Number, value : 0.5 },
		
		/*does there exist something to filter out against so we don't filter everything*/
		canFilter : { type : Boolean, value : false }
		
	},
	
	/*initializes marker and poly arrays*/
	ready : function() {
		var mapsAPI = document.querySelector('google-maps-api');
		mapsAPI.addEventListener('api-load', function(e) {
			// this.api === google.maps
			this.initMap();
		}.bind(this));
		
	},
	
	/*builds map*/
	attached : function() {
		if(mapsInitialized)
			this.initMap();
		else{
			listeners.push(this.initMap.bind(this));
		}
	},
	
	initMap : function() {
		this.displayCenter = this.defaultCenter;
		iconUrl = this.defaultIcon;
		this.defaultMapOptions.center = new google.maps.LatLng(this.displayCenter);
		this.map = new google.maps.Map(this.$.map_canvas, this.defaultMapOptions);
		//stores original height for restoring to later
		originalMapHeight = parseFloat(getComputedStyle(this.$.map_canvas).height);
		bounds = new google.maps.LatLngBounds();
		if(this.allMarkers.length)
			this.map.fitBounds(bounds);
		infowindow = new google.maps.InfoWindow({
			content : 'Hello World!'
		});
		
		this.handleLocation();
		
		this.addNeswPrototype();
		
	},
	
	handleLocation : function () {
		var that = this;
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};
				that.displayCenter = pos;
				that.displayRadius = 1.5;
				that.map.setCenter(pos);
			}, function() {
				console.error('Error: The Geolocation service failed.');
			});
        } else {
			console.error('Error: Your browser doesn\'t support geolocation.')
        }
    },
		
	/*called when loader's request is responded. builds markers from the data*/
	itemsLoaded : function () {
		this.newMarker(loader.lastResponse);
	},
	
	/*creates a new marker from an object or array of objects containing marker options*/
	newMarker : function(object) {
		if(!object instanceof Array){
			object = [object];
			console.log('did i get made into an array?');
		}
		
		console.log(object);
		
		var that = this;
		object.forEach(function(obj){
			if(!obj.lat || !obj.lng)
				throw ("Given marker object has no position!");
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(obj.lat, obj.lng),
				map: that.map,
				title: obj.title || 'Hello World!'
			});
			delete obj.lat;
			delete obj.lng;
			marker.setOptions(obj)
			if(marker.link && 0)
				google.maps.event.addListener(marker, 'click', function() {
					window.location = this.link;
				});
			that.markerInShape(marker);
			that.allMarkers.push(marker);
			bounds.extend(marker.position);
			if(obj.info)
				marker.addListener('click', function() {
					infowindow.setContent(obj.info);
					infowindow.open(this.map, marker);
				});
		});
		this.map.fitBounds(bounds);
	},
	
	/*free hand drawing of polygons. all markers inside shape marked as selected*/
	draw : function (ev) {
		var that = this;
		ev.preventDefault();
		this.disable();
        google.maps.event.addDomListener(this.map.getDiv(),'mousedown',function(e){
			if(that.onePolyActive && that.allPolys.length)
				that.clear(ev);
            that.drawFreeHand();
        });
		
	},
	
	/*first click, clears away polys. second click, clears away marked icons*/
	clear : function (ev) {
		if(this.allPolys.length){
			while(this.allPolys.length)
				this.allPolys.pop().setMap(null);
			return;
		}
				
		for(i = 0; i < this.allMarkers.length; i++){
			if(this.allMarkers[i].getIcon()){
				this.allMarkers[i].setOptions({
					icon: null,
				});
				this.allMarkers[i].selected = false;
			}
		}
			
		canFilter = false;
	},
	
	/*removes all markers that aren't selected*/
	filter : function (ev) {
		if(canFilter)
			for(i = 0; i < this.allMarkers.length; i++)
				if(!this.allMarkers[i].selected)
					this.allMarkers[i].setMap(null);
	},
	
	/*restores map to clean icons of all past loaded markers*/
	reload : function (ev) {
		if(this.allPolys.length)
			this.clear(ev);
		this.clear(ev);
		for(i = 0; i < this.allMarkers.length; i++)
			this.allMarkers[i].setMap(this.map);
		if(this.allMarkers.length)
			this.map.fitBounds(bounds);
		else{
			this.map.setCenter(this.displayCenter);
			this.map.setRadius(this.displayRadius);
		}
		canFilter = false;
	},
	
	/*minimizes height of map as specified by percentMinimize*/
	minimize : function (ev) {
		var minButton = this.$.min_button;
		var mapCanvas = this.$.map_canvas;
		this.displayCenter = this.map.getCenter();
		if(minButton.icon == "expand-less"){
			mapCanvas.style.height = (originalMapHeight * this.percentMinimize).toString() + "px";
			minButton.icon = "expand-more";
		} else {
			mapCanvas.style.height = originalMapHeight.toString() + "px";
			minButton.icon = "expand-less";
			this.$.collapse_button.icon = "fullscreen-exit";
		}
		var that = this;
		setTimeout(function() {
			google.maps.event.trigger(that.map, 'resize');
			that.map.panTo(that.displayCenter);
		}, parseFloat(getComputedStyle(mapCanvas).transitionDuration) * 1000);
	},
	
	/*collapses the element to just the toolbar*/
	collapse : function () {
		var colButton = this.$.collapse_button;
		var mapCanvas = this.$.map_canvas;
		if(this.map.getCenter())
			this.displayCenter = this.map.getCenter();
		if(colButton.icon == "fullscreen-exit"){
			mapCanvas.style.height = 0;
			colButton.icon = "fullscreen";
			this.$.min_button.icon = "expand-more";
		} else {
			mapCanvas.style.height = originalMapHeight.toString() + "px";
			colButton.icon = "fullscreen-exit";
			this.$.min_button.icon = "expand-less";
		}
		var that = this;
		setTimeout(function() {
			google.maps.event.trigger(that.map, 'resize');
			if(that.map.getCenter())
				that.map.panTo(that.displayCenter);
		}, parseFloat(getComputedStyle(mapCanvas).transitionDuration) * 1000);
	},
	
	clearAll : function () {
		while(this.allMarkers.length)
			this.allMarkers.pop().setMap(null);
	},
	
	_radiusChanged : function () {
		var circ = new google.maps.Circle();
		circ.setRadius(this.displayRadius * 1000);
		circ.setCenter(this.displayCenter);
		this.map.fitBounds(circ.getBounds());
	},
	
	_centerChanged : function () {
		if(this.map)
			this.map.setCenter(this.displayCenter);
	},
	
	drawFreeHand : function (){
		//the polygon
		poly = new google.maps.Polyline({map:this.map,clickable:false});
		
		//move-listener
		var move=google.maps.event.addListener(this.map,'mousemove',function(e){
			poly.getPath().push(e.latLng);
		});

		var that = this;
		//mouseup-listener
		google.maps.event.addListenerOnce(this.map,'mouseup',function(e){
			google.maps.event.removeListener(move);
			var path = poly.getPath();
			poly.setMap(null);
			poly = new google.maps.Polygon({ map:that.map, path:path });
			that.allPolys.push(poly);
			google.maps.event.clearListeners(that.map.getDiv(), 'mousedown');
			
			that.enable()
			
			that.markersInShape();
		});
	},

	/*disable and enable turn off map functionality for drawing then turn it back on when done*/
	disable : function(){
        this.map.setOptions({
            draggable: false, 
            zoomControl: false, 
            scrollwheel: false, 
            disableDoubleClickZoom: false,
			clickableIcons: false
        });
    },
    
	enable : function(){
        this.map.setOptions({
            draggable: true, 
            zoomControl: true, 
            scrollwheel: true, 
            disableDoubleClickZoom: true,
			clickableIcons: true
        });
    },
	
	/*checks all markers after a new shape is created*/
	markersInShape : function(){
		var that = this;
		this.allMarkers.forEach(function(marker){
			that.markerInShape(marker);
		});
	},
	
	/*checks a giver marker against all shapes when it is created*/
	markerInShape : function(marker){
		this.allPolys.forEach(function(poly){
			if (google.maps.geometry.poly.containsLocation(marker.position, poly)){
					marker.setOptions({
						icon : iconUrl
					});
					marker.selected = true;
					canFilter = true;
					return;
				}
		});
	},
	
	/* adds function to prototype of a maps polygon.
	 * RETURN: north, east, south, and west bounds of the polygon, as an object*/
	addNeswPrototype : function () {
		google.maps.Polygon.prototype.getNESW = function() {
			var bounds = new google.maps.LatLngBounds();
			var paths = this.getPaths();
			for (var i = 0; i < paths.getLength(); i++) {
				var path = paths.getAt(i);
				for (var j = 0; j < path.getLength(); j++) {
					bounds.extend(path.getAt(j));
				}
			}
			var coords = {
				north:	bounds.getNorthEast().toJSON().lat,
				east:	bounds.getNorthEast().toJSON().lng,
				south:	bounds.getSouthWest().toJSON().lat,
				west:	bounds.getSouthWest().toJSON().lng
			};
			return coords;
		}
	}
	
});
		
	</script>

</dom-module>