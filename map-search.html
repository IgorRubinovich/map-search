<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/google-apis/google-apis.html">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">


<dom-module id="map-search">

	<template>
		<style>
		
			#map_canvas{
				height: 450px;
				width: 100%;
				transition: height 200ms;
			}
			
			paper-icon-button {
				color: white;
			}
		
		</style>

		<div id="wrap">
			<paper-toolbar id="map_functions">
				<span class="title" id="map_title"></span>
				<div id="draw">
					<a href="#" on-click="draw" target="_self" tabindex="-1">
						<paper-icon-button id="draw_icon" icon="create"></paper-icon-button>
					</a>
				</div>
				<div id="clear">
					<a href="#" on-click="clear" target="_self" tabindex="-1">
						<paper-icon-button icon="clear"></paper-icon-button>
					</a>
				</div>
				<div id="reload"> 
					<a href="#" on-click="reload" target="_self" tabindex="-1">
						<paper-icon-button icon="refresh"></paper-icon-button>
					</a>
				</div>
				<div id="minimize">
					<a href="#"  on-click="minimize" target="_self" tabindex="-1">
						<paper-icon-button icon="expand-less" id="min_button"></paper-icon-button>
					</a>
				</div>
				<div id="collapse">
					<a href="#" on-click="collapse" target="_self" tabindex="-1">
						<paper-icon-button icon="fullscreen-exit" id="collapse_button"></paper-icon-button>
					</a>
				</div>
				
			</paper-toolbar>
		</div>	
		<div id="map_canvas"></div>
		
		<google-maps-api id="map-search_api" api-key="AIzaSyBbbTEqaAjcWVDdrIpwlS-0Tl4CTheJThE" version="3.exp" on-api-load="initMap"></google-maps-api>
		
		<iron-ajax
			id="widget_loader"
			handle-as="text"
			debounce-duration="300"
			on-response="widgetLoaded"
			last-response="{{ items }}"
			last-error="{{ lastError }}"
			verbose=true
		></iron-ajax>
		
	</template>
	
  <script>
	
	var mapsInitialized, listeners = [];
	
	Polymer({
	is: 'map-search',

	properties : {
		map : { type: Object },
		
		infowindow : {type: Object},
		
		/*default center of the map*/
		defaultCenter : {
			type : Object,
			value : {
				lat:50.0755,
				lng:14.4378
			},
			readOnly: true
		},
		
		/*point at which to center map at*/
		displayCenter : {
			type : Object,
			observer : '_centerChanged'
		},
		
		/*default map load*/
		defaultMapOptions : {
			type : Object,
			value : {
				zoom: 17,
			}
		},
		
		/*Will be given by user, sets map zoom to fit bounds of circle of radius in km*/
		displayRadius : {
			type : Number,
			observer : '_radiusChanged'
		},
		
		originalMapHeight : { type : Number },
		
		/*All markers that have been loaded onto the map*/
		allMarkers : { type : Array, value : [] },
		
		/*All polys that have been loaded onto the map*/
		allPolys : { type : Array, value : [] },
		
		/*if true, beginning to draw a new poly will erase previous polys*/
		onePolyActive : { type : Boolean, value : true, readOnly : true },
		
		defaultIcon : {
			type : String,
			value : 'http://46.101.211.226:5000/media/assets/theme-vinegret/logo-vinegret-mobile.png'
		},
		
		/*as var name says, percent of height to minimize to when asked to minimize*/
		percentMinimize : { type : Number, value : 0.5 },
		
		/*does there exist something to filter out against so we don't filter everything*/
		canFilter : { type : Boolean, value : false },
		
		template : { type : String, observer : '_templateChanged' },
		
		itemIds : {
			type : Array,
			notify : true
		}
		
	},
	
	_templateChanged : function () {
		this.$.map_title.textContent = this.template.charAt(0).toUpperCase() + this.template.slice(1);;
	},
	
	ready : function() { },
	
	attached : function() { },
	
	initMap : function() {
		this.displayCenter = this.defaultCenter;
		this.defaultMapOptions.center = new google.maps.LatLng(this.displayCenter);
		this.map = new google.maps.Map(this.$.map_canvas, this.defaultMapOptions);
		//stores original height for restoring to later
		originalMapHeight = parseFloat(getComputedStyle(this.$.map_canvas).height);
		bounds = new google.maps.LatLngBounds();
		if(this.allMarkers.length)
			this.map.fitBounds(bounds);
		this.infowindow = new google.maps.InfoWindow({
			content : 'Hello World!'
		});
		
		this.handleLocation();
		
		this.addNeswPrototype();
		
	},
	
	handleLocation : function () {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};
				this.displayCenter = pos;
				this.displayRadius = 1.5;
				this.map.setCenter(pos);
			}.bind(this), function() {
				console.error('Error: The Geolocation service failed.');
			});
        } else {
			console.error('Error: Your browser doesn\'t support geolocation.')
        }
    },
	
	/*creates a new marker from an object or array of objects containing marker options*/
	newMarker : function(object) {
		if(!(object instanceof Array))
			object = [object];
		
		object.forEach(function(obj){
			if(!obj.position)
				throw ("Given marker object has no position!");
			var marker = new google.maps.Marker({ map: this.map });
			marker.setOptions(obj)
			this.allMarkers.push(marker);
			bounds.extend(marker.position);
			
			if(this.template)
				marker.addListener('click', function() {
					var widgetUrl = '/' + this.template + '/partial/' + obj.id + '/widget/';
					this.fire('icon-click', widgetUrl);
					var loader = this.$.widget_loader;
					loader.url = widgetUrl;
					this.infowindow.setContent('<paper-spinner alt="Loading widget" active></paper-spinner>');
					loader.generateRequest();
					this.infowindow.open(this.map, marker);
				}.bind(this));
		}.bind(this));

		this.markersInShape();

		this.map.fitBounds(bounds);
	},
	
	widgetLoaded : function (ev) {
		var loader = this.$.widget_loader;
		
		this.infowindow.setContent(loader.lastResponse);
	},
	
	/*free hand drawing of polygons. all markers inside shape marked as selected*/
	draw : function (ev) {
		ev.preventDefault();
		this.disable();
        google.maps.event.addDomListener(this.map.getDiv(),'mousedown',function(e){
			if(this.onePolyActive && this.allPolys.length)
				this.clear(ev);
            this.drawFreeHand();
        }.bind(this));
	},
	
	/*first click, clears away polys. second click, clears away marked icons*/
	clear : function (ev) {
		if(this.allPolys.length){
			while(this.allPolys.length)
				this.allPolys.pop().setMap(null);
			this.canFilter = false;
			return;
		}
				
		for(i = 0; i < this.allMarkers.length; i++){
			if(this.allMarkers[i].getIcon()){
				this.allMarkers[i].setOptions({
					icon: null,
				});
				this.allMarkers[i].selected = false;
			}
		}
	},
	
	/*removes all markers that aren't selected*/
	filter : function (ev) {
		if(!this.canFilter)
			return;
		var ids = [];
		for(i = 0; i < this.allMarkers.length; i++){
			if(!this.allMarkers[i].selected)
				this.allMarkers[i].setMap(null);
			else 
				ids.push(this.allMarkers[i].id)
		}
		this.set('itemIds', ids);
	},
	
	/*restores map to clean icons of all past loaded markers*/
	reload : function (ev) {
		if(this.allPolys.length)
			this.clear(ev);
		this.clear(ev);
		for(i = 0; i < this.allMarkers.length; i++)
			this.allMarkers[i].setMap(this.map);
		if(this.allMarkers.length)
			this.map.fitBounds(bounds);
		else{
			this.map.setCenter(this.displayCenter);
			this.map.setRadius(this.displayRadius);
		}
		this.canFilter = false;
	},
	
	/*minimizes height of map as specified by percentMinimize*/
	minimize : function (ev) {
		var minButton = this.$.min_button;
		var mapCanvas = this.$.map_canvas;
		this.displayCenter = this.map.getCenter();
		if(minButton.icon == "expand-less"){
			mapCanvas.style.height = (originalMapHeight * this.percentMinimize).toString() + "px";
			minButton.icon = "expand-more";
		} else {
			mapCanvas.style.height = originalMapHeight.toString() + "px";
			minButton.icon = "expand-less";
			this.$.collapse_button.icon = "fullscreen-exit";
		}
		setTimeout(function() {
			google.maps.event.trigger(this.map, 'resize');
			this.map.panTo(this.displayCenter);
		}.bind(this), parseFloat(getComputedStyle(mapCanvas).transitionDuration) * 1000);
	},
	
	/*collapses the element to just the toolbar*/
	collapse : function () {
		var colButton = this.$.collapse_button;
		var mapCanvas = this.$.map_canvas;
		if(this.map.getCenter())
			this.displayCenter = this.map.getCenter();
		if(colButton.icon == "fullscreen-exit"){
			mapCanvas.style.height = 0;
			colButton.icon = "fullscreen";
			this.$.min_button.icon = "expand-more";
		} else {
			mapCanvas.style.height = originalMapHeight.toString() + "px";
			colButton.icon = "fullscreen-exit";
			this.$.min_button.icon = "expand-less";
		}
		setTimeout(function() {
			google.maps.event.trigger(this.map, 'resize');
			if(this.map.getCenter())
				this.map.panTo(this.displayCenter);
		}.bind(this), parseFloat(getComputedStyle(mapCanvas).transitionDuration) * 1000);
	},
	
	clearAll : function () {
		while(this.allMarkers.length)
			this.allMarkers.pop().setMap(null);
	},
	
	_radiusChanged : function () {
		var circ = new google.maps.Circle();
		circ.setRadius(this.displayRadius * 1000);
		circ.setCenter(this.displayCenter);
		this.map.fitBounds(circ.getBounds());
	},
	
	_centerChanged : function () {
		if(this.map)
			this.map.setCenter(this.displayCenter);
	},
	
	drawFreeHand : function (){
		//the polygon
		poly = new google.maps.Polyline({map:this.map,clickable:false});
		
		//move-listener
		var move=google.maps.event.addListener(this.map,'mousemove',function(e){
			poly.getPath().push(e.latLng);
		});

		//mouseup-listener
		google.maps.event.addListenerOnce(this.map,'mouseup',function(e){
			google.maps.event.removeListener(move);
			var path = poly.getPath();
			poly.setMap(null);
			poly = new google.maps.Polygon({ map:this.map, path:path });
			this.allPolys.push(poly);
			google.maps.event.clearListeners(this.map.getDiv(), 'mousedown');
			
			this.enable()
			this.canFilter = true;
			this.markersInShape();
		}.bind(this));
	},

	/*disable and enable turn off map functionality for drawing then turn it back on when done*/
	disable : function(){
        this.map.setOptions({
            draggable: false, 
            zoomControl: false, 
            scrollwheel: false, 
            disableDoubleClickZoom: false,
			clickableIcons: false
        });
    },
    
	enable : function(){
        this.map.setOptions({
            draggable: true, 
            zoomControl: true, 
            scrollwheel: true, 
            disableDoubleClickZoom: true,
			clickableIcons: true
        });
    },
	
	/*checks all markers after a new shape is created*/
	markersInShape : function(){
		this.allMarkers.forEach(function(marker){
			this.markerInShape(marker);
		}.bind(this));
		this.filter();
	},
	
	/*checks a giver marker against all shapes when it is created*/
	markerInShape : function(marker){
		this.allPolys.forEach(function(poly){
			if (google.maps.geometry.poly.containsLocation(marker.position, poly)){
					marker.setOptions({
						icon : this.defaultIcon || ''
					});
					marker.selected = true;
					return;
				}
		});
	},
	
	loadClassified : function(res) {
		this.clearAll();
		var markers = [];
		var ids = []; 
		var geocoder = new google.maps.Geocoder;
		res.forEach(function(obj){
			var position;
			var marker = { id : obj.id };
			ids.push(obj.id);
			geocoder.geocode({'placeId': obj.geo.place_id}, function(results, status) {
				if (status === 'OK') {
					if (results[0]){
						marker.position = results[0].geometry.location;
						markers.push(marker);
						if(markers.length == res.length)
							this.newMarker(markers);
					}else
						console.error('No geocode results found for given object:', obj);
				} else
					console.error('Geocoder failed due to: ' + status);
			}.bind(this));
		}.bind(this));
		this.set('itemIds', ids);
	},
	
	/* adds function to prototype of a maps polygon.
	 * RETURN: north, east, south, and west bounds of the polygon, as an object*/
	addNeswPrototype : function () {
		google.maps.Polygon.prototype.getNESW = function() {
			var bounds = new google.maps.LatLngBounds();
			var paths = this.getPaths();
			for (var i = 0; i < paths.getLength(); i++) {
				var path = paths.getAt(i);
				for (var j = 0; j < path.getLength(); j++) {
					bounds.extend(path.getAt(j));
				}
			}
			var coords = {
				north:	bounds.getNorthEast().toJSON().lat,
				east:	bounds.getNorthEast().toJSON().lng,
				south:	bounds.getSouthWest().toJSON().lat,
				west:	bounds.getSouthWest().toJSON().lng
			};
			return coords;
		}
	}
	
});
		
	</script>

</dom-module>